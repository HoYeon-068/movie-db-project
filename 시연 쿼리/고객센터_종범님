--분실물 조회 프로시저

CREATE OR REPLACE PROCEDURE GET_LOST_ITEM_SEARCH (
    p_theater_name IN VARCHAR2,
    p_keyword IN VARCHAR2,
    p_start_date IN DATE,
    p_end_date IN DATE,
    p_result OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_result FOR
        SELECT l.lost_id,
               l.mem_id,
               l.reporter_name,
               t.theater_id,
               t.theater_name,
               l.title,
               l.content,
               l.status,
               l.created_at,
               l.updated_at
        FROM lost_item l
        JOIN theater t ON l.theater_id = t.theater_id
        WHERE (p_theater_name IS NULL OR t.theater_name LIKE '%' || p_theater_name || '%')
          AND (p_keyword IS NULL OR l.title LIKE '%' || p_keyword || '%')
          AND (p_start_date IS NULL OR l.created_at >= p_start_date)
          AND (p_end_date IS NULL OR l.created_at <= p_end_date)
        ORDER BY l.created_at DESC;
END;
/


--시연 쿼리

-- 분실물 전체 조회
EXEC GET_LOST_ITEM_SEARCH(NULL, NULL, NULL, NULL, :rc);
PRINT rc;
--극장명,분실물로 조회
VARIABLE rc REFCURSOR;
EXEC GET_LOST_ITEM_SEARCH('홍대', '핸드폰', NULL, NULL, :rc);
PRINT rc;





-- 페이지 번호 입력받아 해당 페이지 공지사항 10개 가져오기 --
CREATE OR REPLACE PROCEDURE GET_NOTICE_PAGE (
    p_page IN NUMBER,                
    p_result OUT SYS_REFCURSOR      
)
IS
BEGIN
    OPEN p_result FOR
        SELECT *
        FROM (
            SELECT ROWNUM AS rnum,
                   n.NOTICE_ID,
                   t.THEATER_ID,
                   n.category,          
                   n.TITLE,         
                   n.created_at          
            FROM (
                SELECT NOTICE_ID, THEATER_ID, category, TITLE, created_at
                FROM NOTICE
                ORDER BY created_at DESC
            ) n
            JOIN THEATER t ON n.THEATER_ID = t.THEATER_ID
            WHERE ROWNUM <= p_page * 10
        )
        WHERE rnum > (p_page - 1) * 10;
END;
/

-- 시연 쿼리 --
VAR rc REFCURSOR;
EXEC GET_NOTICE_PAGE(1, :rc);
PRINT rc;
