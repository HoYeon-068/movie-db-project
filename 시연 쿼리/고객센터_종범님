-- 답변 ID 자동 증가용 시퀀스 생성 (새 답변이 등록될 때마다 고유 ID 자동 부여)
CREATE SEQUENCE cinema_user.inquiry_answer_seq
START WITH 1
INCREMENT BY 1
NOCACHE 
NOCYCLE;

-- 테스트용 관리자 계정 추가 (답변을 달 수 있는 관리자)
INSERT INTO member (mem_id, mem_pw, mem_nm, mem_role)
VALUES ('admin001', 'pw123', '관리자', 'A'); 

-- 1:1 문의에 답변 등록 + 문의 상태 자동 변경 프로시저
CREATE OR REPLACE PROCEDURE ADD_INQUIRY_ANSWER (
    p_inquiry_id      IN NUMBER,      -- 답변할 문의 ID
    p_admin_memid     IN VARCHAR2,    -- 답변 관리자 ID
    p_answer_content  IN CLOB          -- 답변 내용
)
IS
BEGIN
    -- 답변 테이블에 새 답변 추가 (시퀀스로 ID 자동 생성, 작성 시간 기록)
    INSERT INTO inquiry_answer (
        answer_id,
        mem_id,
        inquiry_id,
        answer_content,
        answered_at
    )
    VALUES (
        inquiry_answer_seq.NEXTVAL,
        p_admin_memid,
        p_inquiry_id,
        p_answer_content,
        SYSDATE
    );

    -- 문의 테이블의 상태를 '답변완료'로 업데이트
    UPDATE inquiry
    SET inquiry_status = '답변완료'
    WHERE inquiry_id = p_inquiry_id;
END;
/

-- 테스트 답변 등록
EXEC ADD_INQUIRY_ANSWER(3, 'admin001', '테스트용 답변');

-- 등록된 답변 내용 확인
SELECT * FROM inquiry_answer WHERE inquiry_id = 3;

-- 문의 상태가 확인
SELECT inquiry_id, inquiry_status FROM inquiry WHERE inquiry_id = 3;
