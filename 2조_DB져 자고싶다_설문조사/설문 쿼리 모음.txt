--테이블 생성

CREATE TABLE tbl_user(
    user_id VARCHAR2(20) NOT NULL CONSTRAINT PK_TBL_USER_user_id PRIMARY KEY,
    user_password VARCHAR2(20) NOT NULL,
    user_name VARCHAR2(20) NOT NULL,
    user_role VARCHAR2(20) NOT NULL CONSTRAINT CK_TBL_USER_user_role CHECK(user_role IN('회원','관리자'))
);
   
CREATE TABLE tbl_survey(
    survey_no NUMBER NOT NULL,
    writer VARCHAR2(20) NOT NULL,
    question VARCHAR2(150) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    write_date DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT PK_tbl_survey_survey_no PRIMARY KEY(survey_no)
);

CREATE TABLE tbl_option(
    option_id NUMBER NOT NULL CONSTRAINT PK_tbl_option_option_id PRIMARY KEY,
    survey_no NUMBER NOT NULL CONSTRAINT FK_tbl_option_survey_no 
    REFERENCES tbl_survey(survey_no) ON DELETE CASCADE,
    option_num NUMBER(2) NOT NULL,
    content VARCHAR2(100) NOT NULL
);

CREATE TABLE tbl_result(
    result_id NUMBER NOT NULL CONSTRAINT PK_tbl_result_result_id PRIMARY KEY,
    user_id VARCHAR2(20) CONSTRAINT FK_tbl_result_user_id
    REFERENCES tbl_user(user_id),
    option_id NUMBER NOT NULL CONSTRAINT FK_tbl_option_option_id
    REFERENCES tbl_option(option_id)
    ,survey_no NUMBER NOT NULL CONSTRAINT FK_tbl_survey_survey_no
    REFERENCES tbl_survey(survey_no) ON DELETE CASCADE
);


--시퀀스 생성

CREATE SEQUENCE seq_tbl_result
   NOCYCLE 
   CACHE 20;
   
CREATE SEQUENCE seq_tbl_option
   NOCYCLE 
   CACHE 20;
   
CREATE SEQUENCE seq_tbl_survey
   NOCYCLE 
   CACHE 20;





--테스트에 필요한 더미 데이터 

INSERT INTO tbl_user
VALUES('KimHoYeon','1234','김호연','회원');
INSERT INTO tbl_user
VALUES('admin','1234','김호연','관리자');


INSERT INTO tbl_survey
VALUES(seq_tbl_survey.NEXTVAL,'관리자','가장 귀여운 동물은?'
,TO_DATE('2025-10-25','YYYY-MM-DD')
,TO_DATE('2025-10-28 23:59:59','YYYY-MM-DD HH24:MI:SS')
,SYSDATE);

INSERT INTO tbl_survey
VALUES(seq_tbl_survey.NEXTVAL,'관리자','좋아하는 연예인은?'
,TO_DATE('2025-10-25','YYYY-MM-DD')
,TO_DATE('2025-10-30 23:59:59','YYYY-MM-DD HH24:MI:SS')
,SYSDATE);

INSERT INTO tbl_survey
VALUES(seq_tbl_survey.NEXTVAL,'관리자','응원하고 있는 LOL팀은?'
,TO_DATE('2025-10-25','YYYY-MM-DD')
,TO_DATE('2025-11-05 23:59:59','YYYY-MM-DD HH24:MI:SS')
,SYSDATE);

INSERT INTO tbl_survey
VALUES(seq_tbl_survey.NEXTVAL,'관리자','좋아하는 음식은?'
,TO_DATE('2025-10-25','YYYY-MM-DD')
,TO_DATE('2025-11-05 23:59:59','YYYY-MM-DD HH24:MI:SS')
,SYSDATE);



INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,1,'강아지');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,2,'고양이');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,3,'하마');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,4,'사자');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,5,'호랑이');


INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,2,1,'서현');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,2,2,'유리');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,2,3,'윤아');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,2,4,'민아');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,2,5,'츄');

INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,3,1,'T1');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,3,2,'젠지');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,3,3,'한화');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,3,4,'담원');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,3,5,'KT');

INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,4,1,'짜장면');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,4,2,'마라탕');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,4,3,'햄버거');

COMMIT;


INSERT INTO tbl_result
VALUES(seq_tbl_result.NEXTVAL,'admin',1,1);
INSERT INTO tbl_result
VALUES(seq_tbl_result.NEXTVAL,'KimHoYeon',2,1);
INSERT INTO tbl_result
VALUES(seq_tbl_result.NEXTVAL,NULL,1,1);
INSERT INTO tbl_result
VALUES(seq_tbl_result.NEXTVAL,NULL,3,1);
INSERT INTO tbl_result
VALUES(seq_tbl_result.NEXTVAL,NULL,3,1);
INSERT INTO tbl_result
VALUES(seq_tbl_result.NEXTVAL,NULL,2,1);
INSERT INTO tbl_result
VALUES(seq_tbl_result.NEXTVAL,NULL,6,2);






--쿼리 목록


--1번 최신 설문의 질문과 항목들이 나온다
select s.survey_no,s.question,o.option_num,o.content
from tbl_survey s join tbl_option o
on s.survey_no = o.survey_no
where s.survey_no = (SELECT *
FROM 
(SELECT survey_no
FROM tbl_survey
ORDER BY write_date DESC)
WHERE ROWNUM=1) 
order by o.survey_no;


--2번 쿼리 설문 목록 출력

--뷰 사용
CREATE OR REPLACE VIEW surveyView
AS 
    SELECT survey_no"번호",question"질문",writer"작성자",start_date"시작일",end_date"종료일",
    (SELECT COUNT(*) FROM tbl_option WHERE survey_no=s.survey_no)항목수,
    (SELECT COUNT(*) FROM tbl_result WHERE survey_no=s.survey_no)참여자수,
    DECODE(SIGN(end_date-start_date),-1,'종료','진행중')상태
    FROM tbl_survey s;
    
SELECT *
FROM surveyView
ORDER BY 번호 DESC;


--단순 SELECT 문
SELECT survey_no"번호",question"질문",writer"작성자",start_date"시작일",end_date"종료일",
(SELECT COUNT(*) FROM tbl_option WHERE survey_no=s.survey_no)항목수,
(SELECT COUNT(*) FROM tbl_result WHERE survey_no=s.survey_no)참여자수,
DECODE(SIGN(end_date-start_date),-1,'종료','진행중')상태
FROM tbl_survey s
ORDER BY survey_no DESC;


--3번 설문 작성
--입력 받은 항목수에 따라 삽입 (반복)실행
INSERT INTO tbl_survey
VALUES(seq_tbl_survey.NEXTVAL,'관리자','가장 귀여운 동물은?'
,TO_DATE('2025-10-25','YYYY-MM-DD')
,TO_DATE('2025-10-28 23:59:59','YYYY-MM-DD HH24:MI:SS')
,SYSDATE);


INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,1,'강아지');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,2,'고양이');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,3,'하마');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,4,'사자');
INSERT INTO tbl_option
VALUES(seq_tbl_option.NEXTVAL,1,5,'호랑이');



--4번 설문 상세 보기 
--4번-1 선택한 설문 내용 출력하는 쿼리
SELECT s.*,(SELECT COUNT(*) FROM tbl_option WHERE survey_no=s.survey_no)항목수 
FROM tbl_survey s
WHERE question='가장 귀여운 동물은?';

--4번-2 총 참여자 수 조회하는 쿼리
SELECT '총 참여자 수:'||COUNT(*)||'명'"총 참여자 수"
FROM tbl_result
WHERE survey_no=1;


--4번-3 투표하기 관련 쿼리 

-- 투표하는 쿼리
-- 회원일 경우
INSERT INTO tbl_result(result_id,option_id,user_id,survey_no) 
VALUES (seq_tbl_result.NEXTVAL,1,'admin',1);

-- 비회원일 경우
INSERT INTO tbl_result(result_id,option_id,user_id,survey_no) 
VALUES (seq_tbl_result.NEXTVAL,1,null,1);

-- 수정하는 쿼리(회원)
UPDATE tbl_result
SET option_id = 3
WHERE user_id = '관리자' and survey_no = survey_no;

-- 4번-4 그래프에 필요한 쿼리 
--survey_no을 변수에 저장 후 불러왔다고 가정


WITH a AS(
    SELECT option_id,count(*)"결과"
    FROM tbl_result
    WHERE survey_no=1
    GROUP BY option_id
),b AS(
    SELECT *
    FROM tbl_option
    WHERE survey_no=1
)
SELECT content,NVL(결과,0)||'표'결과
,ROUND(NVL(결과,0)/(SELECT SUM(결과) FROM a)*100,2)||' %'"퍼센트"
FROM b
LEFT JOIN a
ON b.option_id=a.option_id
ORDER BY b.option_id;



--5,6번 쿼리 관리자가 수정/삭제

--관리자인지 확인

-- 수정
UPDATE tbl_survey
SET question = '가장 좋아하는 여자 연예인은?'
    ,start_date = TO_DATE('2006-03-01','YYYY-MM-DD')
    ,end_date = TO_DATE('2006-04-01','YYYY-MM-DD')
WHERE survey_no = 1;

--삭제
DELETE FROM tbl_survey
WHERE survey_no = 1;



